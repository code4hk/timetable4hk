<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>timetable4hk Calendar Demo</title>
    <script type="text/javascript" src="ical.js"></script>
    <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="bower_components/moment/min/moment.min.js"></script>
    <script type="text/javascript" src="bower_components/fullcalendar/dist/fullcalendar.min.js"></script>
    <link rel="stylesheet" href="bower_components/fullcalendar/dist/fullcalendar.css" />
    <link rel="stylesheet" href="bower_components/fullcalendar/dist/fullcalendar.print.css" media="print" />
  </head>
  <body>
    <script>
      function ics2fc(arr, str) {
        var jcalData = ICAL.parse(str);
        var comp = new ICAL.Component(jcalData[1]);
        var vevents = comp.getAllSubcomponents("vevent");
        for (var i = 0; i < vevents.length; i++) {
          var vevent = new ICAL.Event(vevents[i]);
          var purl = vevent.component.getFirstProperty("url");
          if (vevent.isRecurring()) {
            var pduration = vevent.component.getFirstProperty("duration");
            var vduration = pduration ? pduration.getFirstValue() : null;
            var it = vevent.iterator();
            for (var d = it.next(); d; d = it.next()) {
              var endTimeStr = null;
              if (vduration) {
                var endTime = d.clone();
                endTime.addDuration(vduration);
                endTimeStr = endTime.toString();
              }
              var obj2 = {
                title: vevent.summary,
                start: d.toString(),
                end: endTimeStr,
                url: purl ? purl.getFirstValue() : null,
              };
              arr[arr.length] = obj2;
            }
          }
          else {
            var obj = {
              title: vevent.summary,
              start: vevent.startDate.toString(),
              end: vevent.endDate ? vevent.endDate.toString() : null,
              url: purl ? purl.getFirstValue() : null,
            };
            arr[arr.length] = obj;
          }
        }
      }

      var icsGot = 0;
      var icsList = [ "legco.ics", "68269_tc.ics", "114453_tc.ics", "119857_tc.ics", "124527_en.ics" ];
      var icsEvents = [];
      for (var i = 0; i < icsList.length; i++) {
        $.get(icsList[i], function(result) {
          icsGot++;
          ics2fc(icsEvents, result);
          if (icsGot >= icsList.length) {
            $("#calendar").fullCalendar({
              header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
              },
              events: icsEvents
            });
          }
        });
      }
    </script>
    <div id="calendar"></div>
  </body>
</html>